<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OIS Admin - Manage Scores</title>
  <link rel="icon" type="image/png" href="favicon-32x32.png">
  
  <style>
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      background: #f0f4f8;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* Back Button */
    .back-btn {
      position: absolute;
      top: 25px;
      left: 25px;
      text-decoration: none;
      color: #0077ff;
      font-size: 0.95em;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      margin-top: 60px;
    }

    h2, h3 { text-align: center; color: #333; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-top: 15px; color: #555; font-size: 0.85em; }
    
    input, select, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 1em;
    }

    button { background: #0077ff; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
    button:hover { background: #005ecb; }
    .logout-btn { background: #666; margin-top: 20px; }

    .hidden { display: none; }

    /* Leaderboard Mini-View */
    .leaderboard { margin-bottom: 30px; display: flex; flex-direction: column; gap: 10px; }
    
    .house {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background: #f9f9f9;
      border-radius: 12px;
    }
    
    .house img {
      width: 40px;
      height: 40px;
      margin-right: 15px;
    }

    .house .info { flex-grow: 1; }
    .house .name { font-weight: bold; margin-left: 15px; font-size: 1.1em; }
    .house .score { font-weight: bold; color: #0077ff; font-size: 1.2em; }
    .house.leader { background: #e0f7ff; }

    /* --- SHIMMER LOADING EFFECT --- */
    /* 1. The base gray style for skeletons */
    .skeleton {
      background-color: #e2e5e7;
      background-image: linear-gradient(
        90deg, 
        rgba(255, 255, 255, 0) 0, 
        rgba(255, 255, 255, 0.5) 50%, 
        rgba(255, 255, 255, 0) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
      display: inline-block;
    }

    /* 2. The shimmer animation */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* 3. Specific sizes for our skeletons */
    .skeleton-img { width: 40px; height: 40px; border-radius: 10%; }
    .skeleton-name { width: 200px; height: 25px; margin-left: 5px; }
    .skeleton-score { width: 25px; height: 25px; border-radius: 10%; }
    /* ---------------------------- */

    hr { border: 0; border-top: 2px solid #eee; margin: 30px 0; }
  </style>
</head>
<body class="loading"> <a href="index.html" class="back-btn"><span>‚Üê</span> Back</a>

  <div class="container">
    <div id="login-section">
      <h2>Admin Login</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()">Login</button>
    </div>

    <div id="admin-section" class="hidden">
      <h3>Current Live Scores</h3>
      <div class="leaderboard" id="admin-leaderboard">
        <div class="house" data-house="red" id="red">
          <div class="skeleton skeleton-img"></div> <div class="info">
            <p class="name"><span class="skeleton skeleton-name"></span></p>
          </div>
          <div class="score"><span class="skeleton skeleton-score"></span></div>
        </div>

        <div class="house" data-house="blue"  id="blue">
          <div class="skeleton skeleton-img"></div> <div class="info">
            <p class="name"><span class="skeleton skeleton-name"></span></p>
          </div>
          <div class="score"><span class="skeleton skeleton-score"></span></div>
        </div>

        <div class="house" data-house="green"  id="green">
          <div class="skeleton skeleton-img"></div> <div class="info">
            <p class="name"><span class="skeleton skeleton-name"></span></p>
          </div>
          <div class="score"><span class="skeleton skeleton-score"></span></div>
        </div>

        <div class="house" data-house="yellow"  id="yellow">
          <div class="skeleton skeleton-img"></div> <div class="info">
            <p class="name"><span class="skeleton skeleton-name"></span></p>
          </div>
          <div class="score"><span class="skeleton skeleton-score"></span></div>
        </div>
      </div>

      <hr>

      <h3>Update House Scores</h3>
      
      <label>Select House:</label>
      <select id="house-select"></select>

      <label>Add Points:</label>
      <input type="number" id="points" value="1">

      <label>Category (Optional):</label>
      <select id="category-select">
        <option value="General/Other">-- General / Other --</option>
      </select>

      <label>Comments (Optional):</label>
      <textarea id="comment" placeholder="Add details here..."></textarea>

      <button onclick="updateScore()">Submit Update</button>
      <button onclick="logout()" class="logout-btn">Logout</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBIIEQt0ryHNulKYNmfCliMywmSzzQuBls",
      authDomain: "my-epic-database.firebaseapp.com",
      databaseURL: "https://my-epic-database-default-rtdb.firebaseio.com",
      projectId: "my-epic-database",
      storageBucket: "my-epic-database.appspot.com",
      messagingSenderId: "533989527206",
      appId: "1:533989527206:web:d34c0a693e6f19dc43ae67"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const houseEls = Array.from(document.querySelectorAll('.house'))

    function login() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, pass).catch(err => alert("Login Failed."));
    }
    
    function logout() { auth.signOut().then(() => location.reload()); }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-section').classList.remove('hidden');
        fetchInitialData();
        startLeaderboardListener();
        startIdleTracking();
      }
    });

    function fetchInitialData() {
      db.ref('Houses').once('value', snapshot => {
        const select = document.getElementById('house-select');
        select.innerHTML = "";
        snapshot.forEach(child => {
          select.add(new Option(child.val().name, child.key));
        });
      });

      db.ref('Categories').once('value', snapshot => {
        const select = document.getElementById('category-select');
        // Keep the "General" option at the top
        snapshot.forEach(child => {
          select.add(new Option(child.val(), child.val()));
        });
      });
    }

    function updateScore() {
      const houseId = document.getElementById('house-select').value;
      const houseName = document.getElementById('house-select').options[document.getElementById('house-select').selectedIndex].text;
      const addedPoints = parseInt(document.getElementById('points').value);
      const category = document.getElementById('category-select').value;
      const comment = document.getElementById('comment').value || "No comment provided"; // Handle empty comment

      if (isNaN(addedPoints)) return alert("Please enter a valid number.");

      const now = new Date();
      const fullTimestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
      
      let oldScore = 0;
      const houseRef = db.ref(`Houses/${houseId}`);

      houseRef.child('score').transaction(current => {
        oldScore = current || 0;
        return oldScore + addedPoints;
      }).then((result) => {
        if(result.committed) {
          db.ref('Logs').push().set({
            fullDateTime: fullTimestamp,
            unixTimestamp: firebase.database.ServerValue.TIMESTAMP,
            houseId: houseId, 
            houseName: houseName,
            previousPoints: oldScore, 
            pointsAdded: addedPoints, 
            newTotal: oldScore + addedPoints,
            category: category, 
            comment: comment, 
            adminEmail: auth.currentUser.email
          });
          alert(`Success! Added ${addedPoints} points to ${houseName}`);
          document.getElementById('comment').value = "";
        }
      });
    }

    function startLeaderboardListener() {
      const houseIds = ['red', 'blue', 'green', 'yellow'];
      db.ref('Houses').on('value', snapshot => {
        const data = snapshot.val();
        if(!data) return;
        // Remove loading state once data arrives
        document.body.classList.remove('loading');

        houseEls.forEach(el => {
          const key = el.dataset.house;
          const scoreEl = el.querySelector('.score');
          const nameEl = el.querySelector('.name');

          // 1. Re-insert the real image (replaces the skeleton-img div)
          // Adjust the path to your local image files
          const imgMap = {
            red: 'icons8-red-panda-100.png',
            blue: 'icons8-animal-100.png',
            green: 'icons8-green-64.png',
            yellow: 'icons8-bee-top-view-100.png'
          };
          
          // 1. Set names and scores immediately after loading
          el.innerHTML = `
            <img src="${imgMap[key]}" alt="${data[key].name}">
            <div class="info"><p class="name">${data[key].name}</p></div>
            <div class="score">${data[key].score}</div>
          `;
        });

        const sorted = houseIds.slice().sort((a,b) => (data[b]?.score || 0) - (data[a]?.score || 0));
        sorted.forEach((id, i) => {
          document.getElementById(id).style.order = i;
          document.getElementById(id).classList.remove('leader');
        });
        document.getElementById(sorted[0]).classList.add('leader');
      });
    }

    let idleTimer;
    function resetTimer() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => { logout(); }, 10 * 60 * 1000);
    }
    function startIdleTracking() {
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(e => {
        document.addEventListener(e, resetTimer, true);
      });
      resetTimer();
    }
  </script>
</body>
</html>


