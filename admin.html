<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OIS Admin - Manage Scores</title>
  <link rel="icon" type="image/png" href="favicon-32x32.png">

  <style>
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      background: #f0f4f8;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* Back Button */
    .back-btn {
      position: absolute;
      top: 25px;
      left: 25px;
      text-decoration: none;
      color: #0077ff;
      font-size: 0.95em;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      margin-top: 60px;
    }

    hr { border: 0; border-top: 2px solid #eee; margin: 30px 0; }
    h2, h3 { text-align: center; color: #333; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-top: 15px; color: #555; font-size: 0.85em; }
    
    input, select, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 1em;
    }

    button { background: #0077ff; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
    button:hover { background: #005ecb; }

    .hidden {display: none !important;}

    /* Leaderboard Mini-View */
    .leaderboard { margin-bottom: 30px; display: flex; flex-direction: column; gap: 10px; }
    
    .house {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background: #f9f9f9;
      border-radius: 12px;
    }
    
    .house img {
      width: 40px;
      height: 40px;
      margin-right: 15px;
    }

    .house .info { flex-grow: 1; }
    .house .name { font-weight: bold; margin-left: 15px; font-size: 1.1em; }
    .house .score { font-weight: bold; font-size: 1.2em; }
    .leader {
      transform: scale(1.02);
    }

       /* Specific glows based on house color */
    .house[data-house="red"].leader {
      background: #fff5f5 !important;
      border: 2px solid #ff4d4d;
      box-shadow: 0 10px 25px rgba(255, 77, 77, 0.2);
    }
    
    .house[data-house="blue"].leader {
      background: #f0f7ff !important;
      border: 2px solid #0077ff;
      box-shadow: 0 10px 25px rgba(0, 119, 255, 0.2);
    }
    
    .house[data-house="green"].leader {
      background: #f2fff5 !important;
      border: 2px solid #2ecc71;
      box-shadow: 0 10px 25px rgba(46, 204, 113, 0.2);
    }
    
    .house[data-house="yellow"].leader {
      background: #fffdf0 !important;
      border: 2px solid #f1c40f;
      box-shadow: 0 10px 25px rgba(241, 196, 15, 0.2);
    }
    
    /* Match the score text color to the house border when leading */
    .house.leader .score {
      color: inherit; /* Takes the color from the card's border/text logic */
    }

    textarea  
    {  
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 1em;
    
      resize: none; 
      height: 100px;

      font-family:"Arial", sans-serif;  
      font-size: 15px;   
    }

    .logs-container {
      margin-top: 20px;
      width: 100%;
      overflow-x: auto;
    }

    #logs-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85em;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }

    #logs-table th, #logs-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    #logs-table th {
      background-color: #f8f9fa;
      color: #666;
      letter-spacing: 0.05em;
    }

    #logs-table tr:last-child td {
      border-bottom: none;
    }

    .read-more {
      color: #0077ff;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.9em;
    }

    .read-more:hover {
      text-decoration: underline;
    }


    /* Style for the description highlights */
    .log-house { font-weight: bold; color: #333; }
    .log-points { font-weight: bold; color: #0077ff; }
    

    /* --- SHIMMER LOADING EFFECT --- */
    /* 1. The base gray style for skeletons */
    .skeleton {
      background-color: #e2e5e7;
      background-image: linear-gradient(
        90deg, 
        rgba(255, 255, 255, 0) 0, 
        rgba(255, 255, 255, 0.5) 50%, 
        rgba(255, 255, 255, 0) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
      display: inline-block;
    }

    /* 2. The shimmer animation */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* 3. Specific sizes for our skeletons */
    .skeleton-img { width: 40px; height: 40px; border-radius: 10%; }
    .skeleton-name { width: 200px; height: 25px; margin-left: 5px; }
    .skeleton-score { width: 25px; height: 25px; border-radius: 10%; }
    /* ---------------------------- */

    /* Recycle Bin Icon Style */
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
    }

    .icon-btn:hover { background: #fee2e2; }
    .icon-btn svg { fill: #ef4444; width: 20px; height: 20px; }

    /* Recycle Bin Section Styles */
    .recycle-section {
      margin-top: 50px;
      background: #fdf2f2;
      border: 1px solid #fecaca;
      padding: 20px;
      border-radius: 12px;
    }

    .recycle-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8em;
      color: #7f1d1d;
    }

    .recycle-table th { text-align: left; padding: 10px; border-bottom: 1px solid #fecaca; }
    .recycle-table td { padding: 10px; border-bottom: 1px solid #fee2e2; }

    /* Restore Icon Style */
    .restore-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .restore-btn:hover { background: #dcfce7; }
    .restore-btn svg { fill: #22c55e; width: 20px; height: 20px; }

    /* Adjusting the recycle table for the new button */
    .recycle-table td:last-child {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* Full screen loading overlay */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(240, 244, 248, 0.9); /* Matches your body background */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    /* The actual spinning circle */
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #ddd;
      border-top: 5px solid #0077ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 15px;
      font-family: Arial, sans-serif;
      color: #333;
      font-weight: bold;
    }

  
  </style>
</head>
<body class="loading"> 
  <a href="index.html" class="back-btn"><span>‚Üê</span> Back</a>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <p class="loading-text">Verifying Credentials...</p>
  </div>
  
  <div id="unauthorized-section" class="hidden" style="text-align: center; margin-top: 100px;">
    <h1 style="font-size: 4em;">üö´</h1>
    <h2>Oh ouh, you are not suppose to be here!</h2>
    <p>This page is restricted to OIS Administrators only.</p>
    <a href="index.html" style="color: #0077ff; font-weight: bold;">Return to Home</a>
  </div>

  
  <div id="admin-section" class="hidden">
    <div class="container">
      <h3>Current Live Scores</h3>
      <div class="leaderboard" id="admin-leaderboard">
        <div class="house" data-house="red" id="red">
          <div class="skeleton skeleton-img"></div> 
          <div class="info"><p class="name"><span class="skeleton skeleton-name"></span></p></div>
          <div class="score"><span class="skeleton skeleton-score"></span></div>
        </div>
        <div class="house" data-house="blue" id="blue">
          <div class="skeleton skeleton-img"></div>
          <div class="info"><p class="name"><span class="skeleton skeleton-name"></span></p></div>
          <div class="score"><span class="skeleton skeleton-score"></span></div>
        </div>
        <div class="house" data-house="green" id="green">
          <div class="skeleton skeleton-img"></div>
          <div class="info"><p class="name"><span class="skeleton skeleton-name"></span></p></div>
          <div class="score"><span class="skeleton skeleton-score"></span></div>
        </div>
        <div class="house" data-house="yellow" id="yellow">
          <div class="skeleton skeleton-img"></div>
          <div class="info"><p class="name"><span class="skeleton skeleton-name"></span></p></div>
          <div class="score"><span class="skeleton skeleton-score"></span></div>
        </div>
      </div>

      <hr>

      <h3>Update House Scores</h3>
      <label>Select House:</label>
      <select id="house-select"></select>

      <label>Category:</label>
      <select id="category-select" onchange="toggleCustomCategory()">
        <option value="">-- Select a Category --</option>
        <option value="Other">Other (Type below...)</option>
      </select>

      <div id="custom-category-container" class="hidden">
        <label>Enter Custom Category:</label>
        <input type="text" id="custom-category-input" placeholder="e.g., House Logo Design">
      </div>

      <label>Event Type:</label>
      <select id="event-type-select" onchange="updateRankingDropdown()">
        <option value="">-- Select Event Type --</option>
        <option value="Group">Group</option>
        <option value="Individual">Individual</option>
      </select>

      <label>Ranking:</label>
      <select id="ranking-select">
        <option value="">-- Select Event Type First --</option>
      </select>

      <label>Comments (Optional):</label>
      <textarea id="comment" placeholder="Add details here..."></textarea>

      <button onclick="updateScore()">Submit Update</button>

      <hr>
      <h3>Recent Activity</h3>
      <div class="logs-container">
        <table id="logs-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Description</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="logs-body"></tbody>
        </table>
        <div id="read-more-container" style="text-align: center; margin-top: 15px;">
          <button type="button" id="read-more-btn" class="read-more-btn" onclick="expandLogs()">Read more...</button>
        </div>
      </div>

      <div class="recycle-section">
        <h3>Recently Deleted</h3>
        <table class="recycle-table">
          <thead>
            <tr>
              <th>Deleted At</th>
              <th>Record</th>
              <th>Action</th> 
            </tr>
          </thead>
          <tbody id="recycle-body"></tbody>
        </table>
      </div>
    </div>
  </div>
  

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBIIEQt0ryHNulKYNmfCliMywmSzzQuBls",
      authDomain: "my-epic-database.firebaseapp.com",
      databaseURL: "https://my-epic-database-default-rtdb.firebaseio.com",
      projectId: "my-epic-database",
      storageBucket: "my-epic-database.appspot.com",
      messagingSenderId: "533989527206",
      appId: "1:533989527206:web:d34c0a693e6f19dc43ae67"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const houseEls = Array.from(document.querySelectorAll('.house'))

    let eventTypeData = {}; // Global variable to store points from DB

    auth.onAuthStateChanged(async (user) => {
    const adminSection = document.getElementById('admin-section');
    const unauthorizedSection = document.getElementById('unauthorized-section');
    const loadingOverlay = document.getElementById('loading-overlay');

    if (user && user.email.endsWith('@oakbridge.edu.my')) {
      // 1. Sanitize the email for Firebase key (dots to commas)
      const emailKey = user.email.toLowerCase().split('.').join(',');
      
      // 2. Check the AdminEmail list in the DB
      db.ref(`AdminEmails/${emailKey}`).once('value', snapshot => {
        if (snapshot.exists()) {
          // SUCCESS: User is an authorized admin
          unauthorizedSection.classList.add('hidden');
          adminSection.classList.remove('hidden');
          loadingOverlay.classList.add('hidden');
          
          // Start all your listeners
          fetchInitialData();
          startLeaderboardListener();
          startIdleTracking();
          startLogsListener();
          startRecycleBinListener();
        } else {
          // FAIL: Logged in with school email, but NOT an admin
          showUnauthorized();
        }
      });
    } else {
      // FAIL: Not logged in or wrong domain
      showUnauthorized();
    }
  });

  function showUnauthorized() {
    document.body.classList.remove('loading');
    document.getElementById('loading-overlay').classList.add('hidden');
    document.getElementById('admin-section').classList.add('hidden');
    document.getElementById('unauthorized-section').classList.remove('hidden');
  }

    // 1. Handle showing/hiding the "Other" text box
    function toggleCustomCategory() {
      const select = document.getElementById('category-select');
      const customContainer = document.getElementById('custom-category-container');
      
      
      if (select.value === "Other") {
        customContainer.classList.remove('hidden');
      } else {
        customContainer.classList.add('hidden');
      }
    }

    function fetchInitialData() {
      db.ref('Houses').once('value', snapshot => {
        const select = document.getElementById('house-select');
        select.innerHTML = "";
        snapshot.forEach(child => {
          select.add(new Option(child.val().name, child.key));
        });
      });

      db.ref('Categories').once('value', snapshot => {
        const select = document.getElementById('category-select');
        // Clear everything except the first (Select) and last (Other)
        const otherOption = select.options[select.options.length - 1];
        const placeholder = select.options[0];
        
        select.innerHTML = "";
        select.add(placeholder);
        
        snapshot.forEach(child => {
          select.add(new Option(child.val(), child.val()));
        });
        
        select.add(otherOption);
      });

      db.ref('EventType').once('value', snapshot => {
        eventTypeData = snapshot.val();
      });
    }

    function updateRankingDropdown() {
      const type = document.getElementById('event-type-select').value;
      const rankSelect = document.getElementById('ranking-select');
      rankSelect.innerHTML = "";

      if (!type || !eventTypeData[type]) {
        rankSelect.add(new Option("-- Select Event Type First --", ""));
        return;
      }

      const scores = eventTypeData[type];
      rankSelect.add(new Option("-- Select Ranking --", ""));

      // Loop through 1, 2, 3, (and 4 if Group)
      Object.keys(scores).forEach(rank => {
        const pts = scores[rank];
        const suffix = (rank == 1) ? "st" : (rank == 2) ? "nd" : (rank == 3) ? "rd" : "th";
        const text = `${rank}${suffix} place - ${pts} points`;
        rankSelect.add(new Option(text, pts)); // Value is the actual points
      });
    }

    function updateScore() {
      const houseId = document.getElementById('house-select').value;
      const houseName = document.getElementById('house-select').options[document.getElementById('house-select').selectedIndex].text;
      const comment = document.getElementById('comment').value || "No comment provided"; // Handle empty comment

      // Category Logic
      const categorySelect = document.getElementById('category-select');
      let category = categorySelect.value;

      // Points are now taken from the ranking dropdown value
      const addedPoints = parseInt(document.getElementById('ranking-select').value);
      const eventType = document.getElementById('event-type-select').value;

      const rankSelect = document.getElementById('ranking-select');
      const rankText = rankSelect.options[rankSelect.selectedIndex].text.split(' - ')[0];

      if (category === "Other") {
        category = document.getElementById('custom-category-input').value.trim();
      }

      // --- VALIDATIONS ---
      if (!eventType) return alert("Please select an Event Type.");
      if (isNaN(addedPoints)) return alert("Please select a Ranking.");
      if (!category) return alert("Category is required.");

      if (!category || category === "") {
        return alert("Category Required: Please select a category or enter a custom one under 'Other'.");
      }

      const now = new Date();
      const fullTimestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
      
      let oldScore = 0;
      const houseRef = db.ref(`Houses/${houseId}`);

      houseRef.child('score').transaction(current => {
        oldScore = current || 0;
        return oldScore + addedPoints;
      }).then((result) => {
        if(result.committed) {
          db.ref('Logs').push().set({
            fullDateTime: fullTimestamp,
            unixTimestamp: firebase.database.ServerValue.TIMESTAMP,
            rankText: rankText,
            houseId: houseId, 
            houseName: houseName,
            previousPoints: oldScore, 
            pointsAdded: addedPoints, 
            newTotal: oldScore + addedPoints,
            category: category, 
            eventType: eventType,
            comment: comment, 
            adminEmail: auth.currentUser.email
          });

          alert(`Success! Added ${addedPoints} points to ${houseName}`);

          document.getElementById('comment').value = "";
          document.getElementById('custom-category-input').value = "";
          document.getElementById('ranking-select').selectedIndex = 0;
          document.getElementById('event-type-select').selectedIndex = 0;
          categorySelect.selectedIndex = 0;
          toggleCustomCategory();
        }
      });
    }

    function startLeaderboardListener() {
      const houseIds = ['red', 'blue', 'green', 'yellow'];
      db.ref('Houses').on('value', snapshot => {
        const data = snapshot.val();
        if(!data) return;
        // Remove loading state once data arrives
        document.body.classList.remove('loading');

        houseEls.forEach(el => {
          const key = el.dataset.house;
          const scoreEl = el.querySelector('.score');
          const nameEl = el.querySelector('.name');

          // 1. Re-insert the real image (replaces the skeleton-img div)
          // Adjust the path to your local image files
          const imgMap = {
            red: 'icons8-red-panda-100.png',
            blue: 'icons8-animal-100.png',
            green: 'icons8-green-64.png',
            yellow: 'icons8-bee-top-view-100.png'
          };
          
          // 1. Set names and scores immediately after loading
          el.innerHTML = `
            <img src="${imgMap[key]}" alt="${data[key].name}">
            <div class="info"><p class="name">${data[key].name}</p></div>
            <div class="score">${data[key].score}</div>
          `;
        });

        const sorted = houseIds.slice().sort((a,b) => (data[b]?.score || 0) - (data[a]?.score || 0));
        sorted.forEach((id, i) => {
          document.getElementById(id).style.order = i;
          document.getElementById(id).classList.remove('leader');
        });
        document.getElementById(sorted[0]).classList.add('leader');
      });
    }

    let displayLimit = 5; // Start with 5

    function expandLogs() {
      displayLimit = 10; // Increase to 50 (or whatever number you prefer)
      startLogsListener(); // Restart the listener with the new limit
      document.getElementById('read-more-container').classList.add('hidden'); // Hide the button
    }

    function startLogsListener() {
      const logsRef = db.ref('Logs');

      // 1. First, check the total count of logs to see if we even need a button
      logsRef.on('value', totalSnapshot => {
        const totalCount = totalSnapshot.numChildren();
        const readMoreContainer = document.getElementById('read-more-container');

        // If total logs in DB is more than what we are currently displaying, show button
        if (totalCount > displayLimit) {
          readMoreContainer.classList.remove('hidden');
        } else {
          readMoreContainer.classList.add('hidden');
        }
      });

      // Listen for the last 5 logs
      logsRef.orderByChild('unixTimestamp').limitToLast(displayLimit).on('value', snapshot => {
        const logsBody = document.getElementById('logs-body');
        logsBody.innerHTML = ""; // Clear current table

        const logs = [];
        snapshot.forEach(child => {
          // 1. Get the data fields (houseName, pointsAdded, etc.)
          const data = child.val();
          // 2. Get the UNIQUE ID (the key like -Njk123...)
          const id = child.key;
          // 3. Combine them into one object and push to our array
          logs.push({ id: id, ...data });
        });

        // Reverse so the newest is at the top
        logs.reverse().forEach(log => {
          const row = logsBody.insertRow();
          
          // Column 1: Time
          const timeCell = row.insertCell(0);
          const AddedAt = new Date(log.unixTimestamp).toLocaleString([], {year:"numeric", month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
          timeCell.innerHTML = `${AddedAt}`;


          // Column 2: Description
          const descCell = row.insertCell(1);
          //const pointText = log.pointsAdded > 0 ? `added ${log.pointsAdded}` : `removed ${Math.abs(log.pointsAdded)}`;
          const rankInfo = log.rankText ? `${log.rankText}` : "";
          
          descCell.innerHTML = `
            <span class="log-house">${log.houseName}</span> added <span class="log-house">${log.pointsAdded} points </span> for winning
            <span class="log-house"> ${rankInfo}</span> in <span class="log-house">${log.category}</span>. 
            <br><small style="color:#888;">"${log.comment}" ‚Äî ${log.adminEmail}</small>
          `;

          const actionCell = row.insertCell(2);
          const btn = document.createElement('button');
          btn.className = "icon-btn";
          btn.title = "Delete and Revert Points";
          btn.innerHTML = `
            <svg viewBox="0 0 24 24">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>`;
          btn.onclick = () => deleteLog(log.id, log);
          actionCell.appendChild(btn)
        });
      });
    }

    function deleteLog(logId, logData) {
      console.log(logId);
      const confirmation = confirm(`Are you sure you want to delete this log? This will remove ${logData.pointsAdded} points from ${logData.houseName}.`);
      
      if (!confirmation) return;

      const houseRef = db.ref(`Houses/${logData.houseId}/score`);

      // 1. Revert the math using a transaction
      houseRef.transaction(currentScore => {
        // To reverse, we SUBTRACT the points that were originally added
        return (currentScore || 0) - logData.pointsAdded;
      }).then((result) => {
        if (result.committed) {
          // 2. Add the log to the Recycle node
          const recycleRef = db.ref('Recycle').push();
          recycleRef.set({
            ...logData,
            deletedAt: firebase.database.ServerValue.TIMESTAMP,
            deletedBy: auth.currentUser.email
          });

          // 3. Remove the original log from Logs
          return db.ref('Logs').child(logId).remove();
          alert("Log deleted and points reverted!");
        }
      }).catch(err => {
        alert("Error reverting points: " + err.message);
      });
    }

    function startRecycleBinListener() {
      const recycleRef = db.ref('Recycle');

      recycleRef.on('value', snapshot => {
        const recycleBody = document.getElementById('recycle-body');
        recycleBody.innerHTML = ""; // Clear table once before the loop

        const deletedItems = [];
        snapshot.forEach(child => {
          // Capture the ID (key) so we can restore it later
          deletedItems.push({ recycleKey: child.key, ...child.val() });
        });

        // Sort by deletion time (newest first)
        deletedItems.sort((a, b) => b.deletedAt - a.deletedAt);

        // Limit to last 5 for now
        deletedItems.slice(0, 5).forEach(item => {
          const row = recycleBody.insertRow();
          
          const deletedAt = new Date(item.deletedAt).toLocaleString([], {year:"numeric", month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
          
          row.insertCell(0).innerHTML = `${deletedAt}`;
          
          const actionText = item.pointsAdded > 0 ? "added" : "removed";
          row.insertCell(1).innerHTML = `
            <strong>${item.houseName}</strong> ${actionText} <strong>${Math.abs(item.pointsAdded)} points </strong>
            by winning <strong>${item.rankText}</strong> in <strong>${item.category}</strong>
            <br><small> Deleted by ‚Äî ${item.deletedBy}</small>
          `;

          // Restore Button Column
          const actionCell = row.insertCell(2);
          const btn = document.createElement('button');
          btn.className = "restore-btn";
          btn.title = "Restore Log and Re-apply Points";
          btn.innerHTML = `
            <svg viewBox="0 0 24 24">
              <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/>
            </svg>`;
          
          btn.onclick = () => restoreLog(item.recycleKey, item);
          actionCell.appendChild(btn);
        });
      });
    }

    function restoreLog(recycleId, itemData) {
      console.log(recycleId);
      const confirmation = confirm(`Restore this log? This will restore ${itemData.pointsAdded} points to ${itemData.houseName}.`);
      if (!confirmation) return;

      const houseRef = db.ref(`Houses/${itemData.houseId}/score`);
      
      // 1. Put the points back
      houseRef.transaction(current => (current || 0) + itemData.pointsAdded)
        .then(() => {
          // 2. Move back to Logs (removing deletion-specific metadata)
          const { deletedAt, deletedBy, id, ...originalLogData } = itemData;
          return db.ref('Logs').push().set(originalLogData);
        })
        .then(() => {
          // 3. Remove from Recycle Bin
          return db.ref('Recycle').child(recycleId).remove();
        })
        .then(() => {
          alert("Log restored successfully!");
        })
        .catch(err => alert("Restore failed: " + err.message));
    }

    let idleTimer;
    function resetTimer() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => { logout(); }, 10 * 60 * 1000);
    }
    function startIdleTracking() {
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(e => {
        document.addEventListener(e, resetTimer, true);
      });
      resetTimer();
    }
  </script>
</body>
</html>
