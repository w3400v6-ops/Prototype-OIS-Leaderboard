<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OIS Admin Panel</title>
  <style>
    body { 
      font-family: 'Arial', sans-serif; 
      background: #f0f4f8; 
      display: flex; 
      justify-content: center; 
      padding: 40px; 
    }

    .container { 
      background: white; 
      padding: 30px; 
      border-radius: 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
      width: 100%; 
      max-width: 400px; 
    }

    h2 { 
      text-align: center; 
      color: #333; 
    }

    label { 
      font-weight: bold; 
      display: block; 
      margin-top: 15px; 
      color: #555; 
    }

    input, select, textarea, button { 
      width: 100%; 
      padding: 12px; 
      margin: 8px 0; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      box-sizing: border-box; 
    }

    button { 
      background: #0077ff; 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: bold; 
      transition: 0.3s; 
    }

    button:hover { 
      background: #005ecb; 
    }

    .hidden { 
      display: none; 
    }

    .error { 
      color: #d32f2f; 
      font-size: 0.9em; 
      text-align: center; 
    }

    .back-btn {
      position: absolute; /* Moves it independently of the centered container */
      top: 25px;
      left: 25px;
      text-decoration: none;
      color: #0077ff;
      font-size: 0.95em;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .back-btn:hover {
      color: #005ecb;
      transform: translateX(-3px); /* Subtle nudge to the left on hover */
    }
  </style>
</head>
<body>

<div class="container">
  <div id="login-section">
    <h2>Admin Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="login-error" class="error"></p>
  </div>

  <div id="admin-section" class="hidden">
    <h2>Update Scores</h2>
    
    <label>Select House:</label>
    <select id="house-select">
      <option value="">Loading houses...</option>
    </select>

    <label>Add Points (Max 10):</label>
    <input type="number" id="points" min="1" max="10" value="1">

    <label>Category:</label>
    <select id="category-select">
      <option value="">Loading categories...</option>
    </select>

    <label>Comments:</label>
    <textarea id="comment" placeholder="Describe why points were awarded"></textarea>

    <button onclick="updateScore()">Update & Log Entry</button>
    <button onclick="logout()" style="background: #666; margin-top: 20px;">Logout</button>
  </div>
</div>

<a href="index.html" class="back-btn">
  <span>‚Üê</span> Back to Leaderboard
</a>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // Your existing Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBIIEQt0ryHNulKYNmfCliMywmSzzQuBls",
    authDomain: "my-epic-database.firebaseapp.com",
    databaseURL: "https://my-epic-database-default-rtdb.firebaseio.com",
    projectId: "my-epic-database",
    storageBucket: "my-epic-database.appspot.com",
    messagingSenderId: "533989527206",
    appId: "1:533989527206:web:d34c0a693e6f19dc43ae67"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // LOGIN LOGIC
  function login() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, pass).catch(err => {
      document.getElementById('login-error').innerText = "Invalid credentials.";
    });
  }

  function logout() {
    auth.signOut().then(() => location.reload());
  }

  // --- SESSION TIMEOUT LOGIC ---
  let idleTimer;
  const TIMEOUT_DURATION = 10 * 60 * 1000; // 10 minutes in milliseconds

  function resetTimer() {
      // Clear the existing timer whenever there is activity
      clearTimeout(idleTimer);
      
      // Start a new timer
      idleTimer = setTimeout(() => {
          alert("Session expired due to inactivity. Logging out...");
          logout();
      }, TIMEOUT_DURATION);
  }

  // Start watching for activity only when the user is logged in
  function startIdleTracking() {
      // Events that count as "activity"
      const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
      
      activityEvents.forEach(event => {
          document.addEventListener(event, resetTimer, true);
      });

      // Initialize the first timer
      resetTimer();
  }

  // Update your existing Auth State observer
  auth.onAuthStateChanged(user => {
      if (user) {
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById('admin-section').classList.remove('hidden');
          fetchDropdownData();
          
          // START THE TIMER HERE
          startIdleTracking();
      }
  });

  // FETCH HOUSES AND CATEGORIES FROM DB
  function fetchDropdownData() {
    // 1. Fetch Houses
    db.ref('Houses').once('value', snapshot => {
      const houseSelect = document.getElementById('house-select');
      houseSelect.innerHTML = ""; // Clear loader
      snapshot.forEach(child => {
        const houseId = child.key;
        const houseName = child.val().name;
        let opt = new Option(houseName, houseId);
        houseSelect.add(opt);
      });
    });

    // 2. Fetch Categories
    db.ref('Categories').once('value', snapshot => {
      const catSelect = document.getElementById('category-select');
      catSelect.innerHTML = ""; // Clear loader
      snapshot.forEach(child => {
        let opt = new Option(child.val(), child.val());
        catSelect.add(opt);
      });
    });
  }

  // SUBMIT UPDATE
  function updateScore() {
    const houseId = document.getElementById('house-select').value;
    const houseName = document.getElementById('house-select').options[document.getElementById('house-select').selectedIndex].text;
    const addedPoints = parseInt(document.getElementById('points').value);
    const category = document.getElementById('category-select').value;
    const comment = document.getElementById('comment').value;

    // Validation
    if (addedPoints > 10 || addedPoints < 1) {
      alert("Point limit exceeded! Max 10.");
      return;
    }
    if (!comment) {
      alert("Please add a comment.");
      return;
    }

    // Generate a readable Date and Time string
    const now = new Date();
    const readableDate = now.toLocaleDateString(); // e.g., "1/29/2026"
    const readableTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // e.g., "1:35 PM"
    const fullTimestamp = `${readableDate} ${readableTime}`;

    const houseRef = db.ref(`Houses/${houseId}`);

    let oldScore = 0;

    houseRef.child('score').transaction(currentScore => {
      oldScore = currentScore || 0;
      return (currentScore || 0) + addedPoints;
    }).then(() => {
      // Add the new readable fields to the Log
      const logRef = db.ref('Logs').push();
      logRef.set({
        fullDateTime: fullTimestamp, // Combined for easy reading
        unixTimestamp: firebase.database.ServerValue.TIMESTAMP, // Kept for backend sorting
        houseId: houseId,
        houseName: houseName,
        previousPoints: oldScore,
        pointsAdded: addedPoints,
        newPoints: oldScore + addedPoints,
        category: category,
        comment: comment,
        adminEmail: auth.currentUser.email
      });

      alert(`Success! Added ${addedPoints} points to ${houseName}`);
      document.getElementById('comment').value = ""; 
    }).catch(err => {
      alert("Update failed: " + err.message);
    });
  }
</script>
</body>
</html>
